library(dplyr)
library(stringr)
library(survival)
library(ggplot2)
setwd("C:/Users/Magda/Desktop/magisterka/stare dane")
load("dane_obrobione.rda")
dt$status_infekcja <- as.numeric(dt$Infekcja)
dt$status_zgon <- as.numeric({dt$Infekcja == 0 & dt$Zgon == 1})
dt$czas <- ifelse(dt$Infekcja == 1, dt$`Cykl Vidazy przy infekcji`, dt$OS)
dt$status <- dt$status_infekcja+2*dt$status_zgon
colnames(dt)[which(colnames(dt) == "Rozpoznanie")] <- "rozpoznanie"
fit_inf <- survfit(Surv(czas, status == 1)~1, data = dt)
survInf <- fit_inf$surv
timeInf <- fit_inf$time
fit_zgon <- survfit(Surv(czas, status == 2)~1, data = dt)
survZgon <- fit_zgon$surv
timeZgon <- fit_zgon$time
cumZgon <- 1- survZgon
to_plot <- cbind(survInf, timeInf, rep(1, times = length(survInf)))
to_plot <- rbind(to_plot, cbind(cumZgon, timeZgon, rep(2, times =length(cumZgon))))
to_plot <- as.data.frame(to_plot)
colnames(to_plot) <- c("prawdopodobieństwo przeżycia", "czas", "status")
to_plot$status <- factor(to_plot$status)
ggplot(to_plot, aes(czas, `prawdopodobieństwo przeżycia`, color = status)) + geom_step(size = 1) + scale_y_continuous(breaks = seq(0,1, length.out = 5), "Prawdopodobieństwo przeżycia (infekcja)", sec.axis=sec_axis(~., name = "1-Prawdopodobieństwo przeżycia (zgon)"))
to_plot2 <- cbind(survInf, timeInf, rep(1, times = length(survInf)))
to_plot2 <- rbind(to_plot2, cbind(survZgon, timeZgon, rep(2, times =length(cumZgon))))
to_plot2 <- as.data.frame(to_plot2)
colnames(to_plot2) <- c("prawdopodobieństwo przeżycia", "czas", "status")
to_plot2$status <- factor(to_plot2$status)
lower <- c(fit_inf$lower, fit_zgon$lower)
upper <- c(fit_inf$upper, fit_zgon$upper)
to_plot2$lower <- lower
to_plot2$upper <- upper
ggplot(to_plot2, aes(czas, `prawdopodobieństwo przeżycia`, color = status)) +
geom_step(size = 1) +
scale_y_continuous("Prawdopodobieństwo przeżycia", limits = c(0,1)) +
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.3) +
xlim(c(0,30))
#conf interval w punkcie 12 (1 rok)
lower_y1 <- to_plot2$lower[which(to_plot2$czas == 12)][1]
upper_y1<- to_plot2$upper[which(to_plot2$czas == 12)][1]
lower_y2 <- to_plot2$lower[which(to_plot2$czas == 12)][2]
upper_y2<- to_plot2$upper[which(to_plot2$czas == 12)][2]
ggplot(to_plot2, aes(czas, `prawdopodobieństwo przeżycia`, color = status)) +
geom_step(size = 1) +
scale_y_continuous("Prawdopodobieństwo przeżycia", limits = c(0,1)) +
geom_errorbar(aes(x = 12, ymin = lower_y1, ymax = upper_y1), color = "grey") +
geom_errorbar(aes(x = 12, ymin = lower_y2, ymax = upper_y2), color = "grey") +
xlim(c(0,30))
#czy to nie jest dziwne, że one zbiegają do tego samego?
#conf intervals nie zawierające wyestymowanej wielkości?
fit_inf_rozp <- summary(survfit(Surv(czas, status == 1)~rozpoznanie, data = dt))
fit_zgon_rozp <- summary(survfit(Surv(czas, status == 2)~rozpoznanie, data = dt))
to_plot3 <- cbind(fit_inf_rozp$strata, fit_inf_rozp$surv, fit_inf_rozp$time, fit_inf_rozp$lower, fit_inf_rozp$upper)
to_plot3 <- rbind(to_plot3, cbind(fit_zgon_rozp$strata, fit_zgon_rozp$surv, fit_zgon_rozp$time, fit_zgon_rozp$lower, fit_zgon_rozp$upper))
to_plot3 <- as.data.frame(to_plot3)
to_plot3$status <- c(rep(1, times = length(fit_inf_rozp$time)), rep(2, times = length(fit_zgon_rozp$time)))
colnames(to_plot3) <- c("rozpoznanie", "przeżycie", "czas", "lower", "upper", "status")
to_plot3$rozpoznanie <- ifelse(to_plot3$rozpoznanie == 1, "AML", ifelse(to_plot3$rozpoznanie == 2, "CMML", "MDS"))
ggplot(to_plot3, aes(czas, przeżycie, color = rozpoznanie)) +
geom_step(size = 1) +
facet_grid(~status) +
xlim(c(0,30))
#troche mało danych, jak tutaj dodać przedziały ufności?
test_inf <- survdiff(Surv(czas, status == 1)~rozpoznanie, data = dt)
test_zgon <- survdiff(Surv(czas, status == 2)~rozpoznanie, data = dt)
test_inf
summary(test_inf)
test_inf
?survdiff
test_zgon
?cosxph
?coxph
coxph(Surv(czas, status==1)~rozpozananie, data = dt)
coxph(Surv(czas, status==1)~rozpoznanie, data = dt)
plot(coxph(Surv(czas, status==1)~rozpoznanie, data = dt))
summary(coxph(Surv(czas, status==1)~rozpoznanie, data = dt))
summary(coxph(Surv(czas, status==2)~rozpoznanie, data = dt))
library(dplyr)
library(stringr)
library(survival)
library(ggplot2)
setwd("C:/Users/Magda/Desktop/magisterka/stare dane")
load("dane_obrobione.rda")
dt$status_infekcja <- as.numeric(dt$Infekcja)
dt$status_zgon <- as.numeric({dt$Infekcja == 0 & dt$Zgon == 1})
dt$czas <- ifelse(dt$Infekcja == 1, dt$`Cykl Vidazy przy infekcji`, dt$OS)
dt$status <- dt$status_infekcja+2*dt$status_zgon
colnames(dt)[which(colnames(dt) == "Rozpoznanie")] <- "rozpoznanie"
library(cmprsk)
ci <- cuminc(dt$czas, dt$status)
plot(ci)
?cuminc
to_plot <- ci[[1]][,1:2]
to_plot <- cbind(ci[[1]][1],ci[[1]][2])
View(to_plot)
to_plot <- ci[[1]][[1]]
to_plot <- cbind(ci[[1]][[1]], ci[[1]][[2]])
View(to_plot)
to_plot <- as.data.frame(cbind(ci[[1]][[1]], ci[[1]][[2]]))
colnames(to_plot) <- c("czas", "prawdopodobieństwo zdarzenia")
to_plot <- as.data.frame(cbind(ci[[1]][[1]], ci[[1]][[2]]))
colnames(to_plot) <- c("czas", "prawdopodobieństwo zdarzenia")
to_plot$status <- rep(1, times = length(to_plot$czas))
to_plot <- rbind(to_plot, cbind(ci[[2]][[1]], ci[[2]][[2]],rep(2, times = length(ci[[2]][[[1]]])))
to_plot <- rbind(to_plot, cbind(ci[[2]][[1]], ci[[2]][[2]],rep(2, times = length(ci[[2]][[[1]])))
to_plot <- rbind(to_plot, cbind(ci[[2]][[1]], ci[[2]][[2]],rep(2, times = length(ci[[2]][[[1]]))))
to_plot <- as.data.frame(cbind(ci[[1]][[1]], ci[[1]][[2]]))
colnames(to_plot) <- c("czas", "prawdopodobieństwo zdarzenia")
to_plot$status <- rep(1, times = length(to_plot$czas))
to_plot <- rbind(to_plot,
cbind(ci[[2]][[1]],
ci[[2]][[2]],
rep(2, times = length(ci[[2]][[1]]))
))
to_plot <- as.data.frame(cbind(ci[[1]][[1]], ci[[1]][[2]]))
to_plot$status <- rep(1, times = length(to_plot$czas))
to_plot <- as.data.frame(cbind(ci[[1]][[1]], ci[[1]][[2]]))
to_plot$status <- rep(1, times = length(to_plot$V1))
to_plot <- rbind(to_plot,
cbind(ci[[2]][[1]],
ci[[2]][[2]],
rep(2, times = length(ci[[2]][[1]]))
))
to_plot <- as.data.frame(cbind(ci[[1]][[1]], ci[[1]][[2]]))
to_plot$status <- rep(1, times = length(to_plot$V1))
View(to_plot)
to_plot <- rbind(to_plot,
cbind(ci[[2]][[1]],
ci[[2]][[2]],
rep(2, times = length(ci[[2]][[1]]))
))
to_plot2 <- cbind(ci[[2]][[1]],
ci[[2]][[2]],
rep(2, times = length(ci[[2]][[1]]))
)
to_plot <- rbind(to_plot, to_plot2)
to_plot <- as.data.frame(cbind(ci[[1]][[1]], ci[[1]][[2]]))
to_plot$status <- rep(1, times = length(to_plot$V1))
to_plot2 <- rbind(to_plot, as.data.frame(cbind(ci[[2]][[1]],
ci[[2]][[2]],
rep(2, times = length(ci[[2]][[1]]))
)))
to_plot <- as.data.frame(cbind(ci[[1]][[1]], ci[[1]][[2]]))
to_plot$V3 <- rep(1, times = length(to_plot$V1))
to_plot2 <- rbind(to_plot, as.data.frame(cbind(ci[[2]][[1]],
ci[[2]][[2]],
rep(2, times = length(ci[[2]][[1]]))
)))
to_plot <- rbind(to_plot, as.data.frame(cbind(ci[[2]][[1]],
ci[[2]][[2]],
rep(2, times = length(ci[[2]][[1]]))
)))
colnames(to_plot) <- c("czas", "prawdopodobieństwo zdarzenia")
colnames(to_plot) <- c("czas", "prawdopodobieństwo zdarzenia", "status")
to_plot$`prawdopodobienstwo przezycia` <- sapply(to_plot$`prawdopodobieństwo zdarzenia`, function(x) 1-x)
View(to_plot2)
View(to_plot)
library(dplyr)
library(stringr)
library(survival)
library(ggplot2)
library(cmprsk)
setwd("C:/Users/Magda/Desktop/magisterka/stare dane")
load("dane_obrobione.rda")
dt$status_infekcja <- as.numeric(dt$Infekcja)
dt$status_zgon <- as.numeric({dt$Infekcja == 0 & dt$Zgon == 1})
dt$czas <- ifelse(dt$Infekcja == 1, dt$`Cykl Vidazy przy infekcji`, dt$OS)
dt$status <- dt$status_infekcja+2*dt$status_zgon
colnames(dt)[which(colnames(dt) == "Rozpoznanie")] <- "rozpoznanie"
ci <- cuminc(dt$czas, dt$status)
to_plot <- as.data.frame(cbind(ci[[1]][[1]], ci[[1]][[2]]))
to_plot$V3 <- rep(1, times = length(to_plot$V1))
to_plot <- rbind(to_plot, as.data.frame(cbind(ci[[2]][[1]],
ci[[2]][[2]],
rep(2, times = length(ci[[2]][[1]]))
)))
colnames(to_plot) <- c("czas", "prawdopodobieństwo zdarzenia", "status")
to_plot$`prawdopodobieństwo przeżycia` <- sapply(to_plot$`prawdopodobieństwo zdarzenia`, function(x) 1-x)
ggplot(to_plot2, aes(czas, `prawdopodobieństwo przeżycia`, color = status)) +
geom_step(size = 1) +
scale_y_continuous("Prawdopodobieństwo przeżycia", limits = c(0,1))
ggplot(to_plot, aes(czas, `prawdopodobieństwo przeżycia`, color = status)) +
geom_step(size = 1) +
scale_y_continuous("Prawdopodobieństwo przeżycia", limits = c(0,1))
to_plot$status <- factor(to_plot$status)
ggplot(to_plot, aes(czas, `prawdopodobieństwo przeżycia`, color = status)) +
geom_step(size = 1) +
scale_y_continuous("Prawdopodobieństwo przeżycia", limits = c(0,1))
lowerConf <- function(est, var){
lowerConf <- exp(log(est) - 1.96*sqrt(var)/est)
}
upperConf <- function(est, var){
upperCinf <- exp(log(est) + 1.96*sqrt(var)/est)
}
to_plot2 <- as.data.frame(cbind(ci[[1]][[3]], ci[[2]][3]))
to_plot2 <- as.data.frame(rbind(ci[[1]][[3]], ci[[2]][3]))
View(to_plot2)
to_plot2 <- as.data.frame(rbind(ci[[1]][[3]], ci[[2]][3]))
to_plot2 <- as.data.frame(c(ci[[1]][[3]], ci[[2]][3]))
View(to_plot2)
to_plot2 <- as.data.frame(rbind(ci[[1]][[3]], ci[[2]][3]))
ci[[1]][[3]]
to_plot2 <- rbind(ci[[1]][[3]], ci[[2]][3])
View(to_plot2)
var1 <- cbind(ci[[1]][[3]], ci[[2]][[3]])
var1 <- rbind(ci[[1]][[3]], ci[[2]][[3]])
var1 <- rbind(ci[[1]][[3]], ci[[2]][[3]])
var1 <- ci[[1]][[3]]
var2 <- ci[[2]][[3]]
var <- rbind(var1, var2)
var <- c(var1, var2)
to_plot2 <- cbind(to_plot, var)
View(to_plot2)
?sapply
?mapply
mapply(lowerConf(to_plot2$`prawdopodobieństwo przeżycia`, to_plot2$var))
lowerConf(to_plot2$`prawdopodobieństwo przeżycia`, to_plot2$var)
lowerConf(to_plot2$`prawdopodobieństwo przeżycia`, to_plot2$var) -> x
x
to_plot2$upper <- upperConf(to_plot2$`prawdopodobieństwo przeżycia`, to_plot2$var)
to_plot2$lower <- lowerConf(to_plot2$`prawdopodobieństwo przeżycia`, to_plot2$var)
View(to_plot2)
lower <- lowerConf(to_plot2$`prawdopodobieństwo przeżycia`, to_plot2$var)
upper <- upperConf(to_plot2$`prawdopodobieństwo przeżycia`, to_plot2$var)
lower1 <- lower[1:34]
lower2 <- lower[35:70]
upper1 <- upper[1:34]
upper2 <= upper[35:70]
upper2 <- upper[35:70]
ggplot(to_plot2, aes(czas, `prawdopodobieństwo przeżycia`, color = status)) +
geom_step(size = 1) +
scale_y_continuous("Prawdopodobieństwo przeżycia", limits = c(0,1)) +
geom_errorbar(aes(x = 12, ymin = lower1, ymax = upper1), color = "grey") +
geom_errorbar(aes(x = 12, ymin = lower2, ymax = upper2), color = "grey") +
xlim(c(0,30))
ggplot(to_plot, aes(czas, `prawdopodobieństwo przeżycia`, color = status)) +
geom_step(size = 1) +
scale_y_continuous("Prawdopodobieństwo przeżycia", limits = c(0,1))
ggplot(to_plot2, aes(czas, `prawdopodobieństwo przeżycia`, color = status)) +
geom_step(size = 1) +
scale_y_continuous("Prawdopodobieństwo przeżycia", limits = c(0,1)) +
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.3) +
xlim(c(0,30))
ggplot(to_plot2, aes(czas, `prawdopodobieństwo przeżycia`, color = status)) +
geom_step(size = 1) +
scale_y_continuous("Prawdopodobieństwo przeżycia", limits = c(0,1)) +
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.3) +
xlim(c(0,30))
?cuminc
ci <- cuminc(dt$czas, dt$status, group = dt$rozpoznanie)
ci
?crr
cov <- model.matrix(~dt$rozpoznanie)
View(cov)
cov <- model.matrix(~dt$rozpoznanie)[,-1]
crr1 <- crr(dt$czas, dt$status, cov1 = cov, failcode = 1)
crr()
crr1
summary(crr1)
crr2 <- crr(dt$czas, dt$status, cov1 = cov, failcode = 2)
summary(crr2)
library(dplyr)
library(stringr)
library(survival)
library(ggplot2)
library(cmprsk)
setwd("C:/Users/Magda/Desktop/magisterka/stare dane")
load("dane_obrobione.rda")
dt$status_infekcja <- as.numeric(dt$Infekcja)
dt$status_zgon <- as.numeric({dt$Infekcja == 0 & dt$Zgon == 1})
dt$czas <- ifelse(dt$Infekcja == 1, dt$`Cykl Vidazy przy infekcji`, dt$OS)
dt$status <- dt$status_infekcja+2*dt$status_zgon
colnames(dt)[which(colnames(dt) == "Rozpoznanie")] <- "rozpoznanie"
ci <- cuminc(dt$czas, dt$status)
to_plot <- as.data.frame(cbind(ci[[1]][[1]], ci[[1]][[2]]))
to_plot$V3 <- rep(1, times = length(to_plot$V1))
to_plot <- rbind(to_plot, as.data.frame(cbind(ci[[2]][[1]],
ci[[2]][[2]],
rep(2, times = length(ci[[2]][[1]]))
)))
colnames(to_plot) <- c("czas", "prawdopodobieństwo zdarzenia", "status")
to_plot$status <- factor(to_plot$status)
to_plot$`prawdopodobieństwo przeżycia` <- sapply(to_plot$`prawdopodobieństwo zdarzenia`, function(x) 1-x)
ggplot(to_plot, aes(czas, `prawdopodobieństwo przeżycia`, color = status)) +
geom_step(size = 1) +
scale_y_continuous("Prawdopodobieństwo przeżycia", limits = c(0,1))
lowerConf <- function(est, var){
lowerConf <- exp(log(est) - 1.96*sqrt(var)/est)
}
upperConf <- function(est, var){
upperCinf <- exp(log(est) + 1.96*sqrt(var)/est)
}
var1 <- ci[[1]][[3]]
var2 <- ci[[2]][[3]]
var <- c(var1, var2)
to_plot2 <- cbind(to_plot, var)
lower <- lowerConf(to_plot2$`prawdopodobieństwo przeżycia`, to_plot2$var)
upper <- upperConf(to_plot2$`prawdopodobieństwo przeżycia`, to_plot2$var)
ggplot(to_plot2, aes(czas, `prawdopodobieństwo przeżycia`, color = status)) +
geom_step(size = 1) +
scale_y_continuous("Prawdopodobieństwo przeżycia", limits = c(0,1)) +
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.3) +
xlim(c(0,30))
ggplot(to_plot2, aes(czas, `prawdopodobieństwo przeżycia`, color = status)) +
geom_step(size = 1) +
scale_y_continuous("Prawdopodobieństwo przeżycia", limits = c(0,1)) +
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.3) +
xlim(c(0,40))
ggplot(to_plot2, aes(czas, `prawdopodobieństwo przeżycia`, color = status)) +
geom_step(size = 1) +
scale_y_continuous("Prawdopodobieństwo przeżycia", limits = c(0,1)) +
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.3)
ci <- cuminc(dt$czas, dt$status, group = dt$rozpoznanie)
ci
summary(ci)
ci
?cuminc
ci <- cuminc(dt$czas, dt$status==1, group = dt$rozpoznanie)
ci
ci
cov <- model.matrix(~dt$rozpoznanie)[,-1]
crr1 <- crr(dt$czas, dt$status, cov1 = cov, failcode = 1)
summary(crr1)
crr2 <- crr(dt$czas, dt$status, cov1 = cov, failcode = 2)
summary(crr2)
est <- c(0,0,0)
for(i in names(ci)[1:6]){
x <- cbind(ci[[i]]$est, ci[[i]]$time, rep(i, times = length(ci[[i]]$est)))
est <- rbind(est, x)
}
est <- as.data.frame(est)
est <- est[-1,]
colnames(est) <- c("cumulative incidence", "czas", "rozp")
est$`cumulative incidence` <- as.numeric(as.character(est$`cumulative incidence`))
est$czas <- as.numeric(as.character(est$czas))
est$rozp <- as.character(est$rozp)
est$grupa <- sapply(est$rozp, function(x) strsplit(x, " ")[[1]][1])
est$status <- sapply(est$rozp, function(x) strsplit(x, " ")[[1]][2])
ggplot(est, aes(czas, `cumulative incidence`, color = grupa)) + geom_step(size = 1) + facet_wrap(~status)+xlim(c(0,30))
lowerConf <- function(est, var){
lowerConf <- exp(log(est) - 1.96*sqrt(var)/est)
}
upperConf <- function(est, var){
upperCinf <- exp(log(est) + 1.96*sqrt(var)/est)
}
y_min_AML1 <- lower(ci[[1]]$est[which(ci[[1]]$time == 12)])
y_min_AML1 <- lowerConf(ci[[1]]$est[which(ci[[1]]$time == 12)])
y_min_AML1 <- lowerConf(ci[[1]]$est[which(ci[[1]]$time ==12)],
ci[[1]]$var[which(ci[[1]]$time == 12)] )
y_min_AML1
ci[[1]]$est[which(ci[[1]]$time ==12)]
ci[[1]]$var[which(ci[[1]]$time == 12)
]
ci[[1]]$time
ggplot(est, aes(czas, `cumulative incidence`, color = grupa)) + geom_step(size = 1) + facet_wrap(~status)+xlim(c(0,30))
y_min_AML1 <- lowerConf(ci[[1]]$est[which.max(ci[[1]]$time < 12)])
y_min_AML1 <- lowerConf(ci[[1]]$est[which.max(ci[[1]]$time <= 12)],
ci[[1]]$var[which.max(ci[[1]]$time < 12)])
y_min_AML1 <- lowerConf(ci[[1]]$est[which.max(ci[[1]]$time <= 12)],
ci[[1]]$var[which.max(ci[[1]]$time <= 12)])
ci[[1]]$est[which.max(ci[[1]]$time <= 12)]
which.max(ci[[1]]$time <= 12)
ci[[1]]$est[which.max(ci[[1]]$time >12)-1]
y_min_AML1 <- lowerConf(ci[[1]]$est[which.max(ci[[1]]$time >12)-1],
ci[[1]]$var[which.max(ci[[1]]$time > 12)-1])
y_max_AML1 <- upperConf(ci[[1]]$est[which.max(ci[[1]]$time >12)-1],
ci[[1]]$var[which.max(ci[[1]]$time > 12)-1])
ggplot(est, aes(czas, `cumulative incidence`, color = grupa)) +
geom_step(size = 1) +
facet_wrap(~status)+xlim(c(0,30)) +
geom_errorbar(aes(x = 12, ymin = y_min_AML1, ymax = y_max_AML1), color = "grey") +
ggplot(est, aes(czas, `cumulative incidence`, color = grupa)) +
geom_step(size = 1) +
facet_wrap(~status)+xlim(c(0,30)) +
geom_errorbar(aes(x = 12, ymin = y_min_AML1, ymax = y_max_AML1), color = "grey")
ggplot(est, aes(czas, `cumulative incidence`, color = grupa)) +
geom_step(size = 1) +
facet_wrap(~status)+xlim(c(0,30)) +
geom_errorbar(aes(x = 12, ymin = y_min_AML1, ymax = y_max_AML1), color = "grey", size = 1)
